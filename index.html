<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>v-curtains Shader Test</title>
  <style>
    body {
      /* make the body fits our viewport */
      position: relative;
      width: 100%;
      height: 100vh;
      margin: 0;
      overflow: hidden;
      font-family: 'PT Sans', Verdana, sans-serif;
      font-size: 18px;
    }

    #shaderTest {
      /* make the canvas wrapper fits the document */
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
    }

    #back-to-lib-link {
      display: inline-block;
      position: fixed;
      top: 0;
      right: 0;
      padding: 0.25em 0.5em;
      background: #ee6557;
      color: white;
      text-decoration: none;
      z-index: 20;
      font-size: 0.85em;
    }

    #back-to-lib-link:hover {
      background: black;
    }

    #source-code-link {
      display: inline-block;
      position: fixed;
      bottom: 1em;
      right: 1em;
      padding: 0.25em 0.5em;
      background: #ee6557;
      color: white;
      text-decoration: none;
      z-index: 20;
    }

    #source-code-link:hover {
      background: black;
    }

    .wrapper {
      width: 100%;
      height: 100vh;
      display: flex;
    }

    #plane {
      /* define the size of your plane */
      width: 80%;
      height: 80vh;
      margin: 10vh auto;
    }

    #plane img {
      /* hide the img element */
      display: none;
    }

    .text-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 24px;
      z-index: 2;
      pointer-events: none;
    }
  </style>
</head>

<body>

  <a href="https://www.curtainsjs.com/" title="back to curtains.js website" id="back-to-lib-link" target="_blank">back
    to curtains.js website</a>

  <v-curtains id="shaderTest-v" container-id="shaderTest">
    <div class="wrapper">
      <div id="plane">
        <img src="./plane-small-texture-3.jpg" crossorigin="" />
        <div class="text-overlay">123</div>
      </div>
    </div>
  </v-curtains>

  <script type="module">
    import { VCurtains } from '/src/components/v-curtains.ts';
    import { Plane } from "curtainsjs"
    const planeElements = document.getElementById("plane");
    const curtainsComponentV = (/** @type {VCurtains} */(document.getElementById('shaderTest-v')));
    // 顶点着色器
    const vertexShader = /** glsl */`
    precision mediump float;

			// those are the mandatory attributes that the lib sets
			attribute vec3 aVertexPosition;
			attribute vec2 aTextureCoord;

			// those are mandatory uniforms that the lib sets and that contain our model view and projection matrix
			uniform mat4 uMVMatrix;
			uniform mat4 uPMatrix;

			// our texture matrix that will handle image cover
			uniform mat4 uTextureMatrix0;

			// if you want to pass your vertex and texture coords to the fragment shader
			varying vec3 vVertexPosition;
			varying vec2 vTextureCoord;

			void main() {
				vec3 vertexPosition = aVertexPosition;

				gl_Position = uPMatrix * uMVMatrix * vec4(vertexPosition, 1.0);

				// set the varyings
				// here we use our texture matrix to calculate te accurate texture coords
				vTextureCoord = (uTextureMatrix0 * vec4(aTextureCoord, 0.0, 1.0)).xy;
				vVertexPosition = vertexPosition;
			}
  `;

    // 片元着色器
    const fragmentShader = /** glsl */`
    precision mediump float;

			// get our varyings
			varying vec3 vVertexPosition;
			varying vec2 vTextureCoord;

			// the uniform we declared inside our javascript
			uniform float uTime;

			// our texture sampler (default name, to use a different name please refer to the documentation)
			uniform sampler2D uSampler0;

			void main() {
				vec2 textureCoord = vTextureCoord;

				// displace our pixels along the X axis based on our time uniform
				// textures coords are ranging from 0.0 to 1.0 on both axis
				textureCoord.x += sin(textureCoord.y * 25.0) * cos(textureCoord.x * 25.0) * (cos(uTime / 50.0)) / 25.0;

				gl_FragColor = texture2D(uSampler0, textureCoord);
			}
  `;

    window.addEventListener('load', () => {
      // 创建平面参数
      const planeParams = {
        vertexShader: vertexShader,
        fragmentShader: fragmentShader,
        uniforms: {
          time: {
            name: "uTime",
            type: "1f",
            value: 0,
          }
        }
      };

      const ctx2d = (/** @type { CanvasRenderingContext2D  } */(curtainsComponentV.context2d))
      // ctx.fillStyle = 'white';
      // ctx.font = '24px Arial';
      // ctx.fillText('123', 400, 300);
      console.log(ctx2d);
      // const plane = new Plane(curtains, curtainsComponent, planeParams);
      const plane = curtainsComponentV.createPlane((curtains) => {
        return new Plane(curtains, planeElements, planeParams);
      })


      plane.onRender(() => {
        plane.uniforms.time.value++;
      });
    })
  </script>
</body>

</html>